generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
  engineType      = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String            @id @default(cuid())
  email            String            @unique
  name             String?
  passwordHash     String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  articles         Article[]
  automationConfig AutomationConfig?
  automationJobs   AutomationJob[]
  subscription     Subscription?
  usageStats       UsageStats?
  wordpressSites   WordPressSite[]
}

model Subscription {
  id                   String   @id @default(cuid())
  userId               String   @unique
  tier                 String
  status               String
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  stripeCustomerId     String?
  stripeSubscriptionId String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model WordPressSite {
  id          String    @id @default(cuid())
  userId      String
  siteUrl     String
  siteName    String
  username    String
  appPassword String
  isActive    Boolean   @default(true)
  lastSync    DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  articles    Article[]
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ResearchJob {
  id           String    @id @default(cuid())
  userId       String
  seeds        Json
  sources      Json
  persona      Json
  status       String
  progress     Int       @default(0)
  currentTask  String?
  researchData Json?
  startedAt    DateTime?
  completedAt  DateTime?
  error        String?
  createdAt    DateTime  @default(now())
  article      Article?
  keywords     Keyword[]

  @@index([userId, status])
  @@index([createdAt])
}

model Keyword {
  id            String      @id @default(cuid())
  researchJobId String
  phrase        String
  score         Float
  searchVolume  Int?
  competition   Float
  relevance     Float
  trending      String
  redditPosts   Int         @default(0)
  sePosts       Int         @default(0)
  snippetChance Float       @default(0)
  selected      Boolean     @default(false)
  createdAt     DateTime    @default(now())
  researchJob   ResearchJob @relation(fields: [researchJobId], references: [id], onDelete: Cascade)

  @@index([researchJobId, score])
  @@index([phrase])
}

model Article {
  id             String         @id @default(cuid())
  userId         String
  siteId         String?
  researchJobId  String?        @unique
  title          String
  slug           String
  content        String
  focusKeyword   String
  metaTitle      String
  metaDesc       String
  wordCount      Int
  h2Count        Int
  h3Count        Int
  keywordDensity Float
  rankMathScore  Int?
  estimatedScore Int
  status         String
  scheduledFor   DateTime?
  publishedAt    DateTime?
  wpPostId       Int?
  wpPostUrl      String?
  error          String?
  persona        Json
  referenceInfo  Json?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  researchJob    ResearchJob?   @relation(fields: [researchJobId], references: [id], onDelete: Cascade)
  site           WordPressSite? @relation(fields: [siteId], references: [id])
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  images         Image[]

  @@index([userId, status])
  @@index([createdAt])
}

model Image {
  id            String   @id @default(cuid())
  articleId     String
  type          String
  url           String
  path          String?
  altText       String
  prompt        String
  revisedPrompt String?
  wpMediaId     Int?
  position      String
  width         Int?
  height        Int?
  size          Int?
  format        String?
  createdAt     DateTime @default(now())
  article       Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@index([articleId])
}

model UsageStats {
  id                String   @id @default(cuid())
  userId            String   @unique
  articlesThisMonth Int      @default(0)
  articlesLimit     Int      @default(5)
  imagesThisMonth   Int      @default(0)
  imagesLimit       Int      @default(5)
  totalArticles     Int      @default(0)
  totalImages       Int      @default(0)
  totalWordCount    Int      @default(0)
  costThisMonth     Float    @default(0)
  lastResetAt       DateTime @default(now())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CostLog {
  id           String   @id @default(cuid())
  userId       String
  type         String
  model        String?
  inputTokens  Int?
  outputTokens Int?
  cost         Float
  articleId    String?
  createdAt    DateTime @default(now())

  @@index([userId, createdAt])
  @@index([type])
}

model AutomationJob {
  id                String    @id @default(cuid())
  userId            String
  articlesCount     Int
  publishType       String
  scheduleInterval  Int?
  category          String?
  status            String
  progress          Int       @default(0)
  articlesGenerated Int       @default(0)
  articlesPublished Int       @default(0)
  articlesFailed    Int       @default(0)
  totalCost         Float     @default(0)
  startedAt         DateTime?
  completedAt       DateTime?
  error             String?
  createdAt         DateTime  @default(now())
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([createdAt])
}

model AutomationConfig {
  id                 String    @id @default(cuid())
  userId             String    @unique
  enabled            Boolean   @default(false)
  frequency          String
  hour               Int       @default(9)
  dayOfWeek          Int?
  articlesPerRun     Int       @default(5)
  publishImmediately Boolean   @default(true)
  scheduleInterval   Int?
  seedStrategy       String    @default("weighted")
  personaStrategy    String    @default("rotation")
  category           String    @default("medicare")
  lastRunAt          DateTime?
  nextRunAt          DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AutomationLog {
  id                String   @id @default(cuid())
  userId            String
  articlesCreated   Int
  articlesPublished Int
  articlesFailed    Int
  totalCost         Float?
  duration          Int?
  errors            Json?
  createdAt         DateTime @default(now())

  @@index([userId, createdAt])
}

model SystemUsage {
  id            String   @id @default("system")
  serpApiUsed   Int      @default(0)
  serperUsed    Int      @default(0)
  lastResetAt   DateTime @default(now())
  updatedAt     DateTime @updatedAt
}
